// main.js

import { saveItems, loadItems } from './storage.js'; 
import * as Catalog from './catalog.js';

// Получение элементов DOM (ввод)
const nameInput = document.getElementById('nameInput');
const priceInput = document.getElementById('priceInput');
const categoryInput = document.getElementById('categoryInput');
const imageInput = document.getElementById('imageInput'); // НОВЫЙ ВВОД
const addBtn = document.getElementById('addBtn');

// Получение элементов DOM (список и поиск)
const catalogListElem = document.getElementById('catalogList');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const resetBtn = document.getElementById('resetBtn');


// --- 1. Логика отображения ---

const handleRemove = (id) => {
    /** Обработчик удаления товара. */
    if (Catalog.removeItem(id)) {
        saveItems(Catalog.getAllItems());
        updateView();
    }
};

const updateView = (currentItems = Catalog.getAllItems()) => {
    /** Функция обновления интерфейса: рендерит список, включая изображения. */
    catalogListElem.innerHTML = ''; 

    if (currentItems.length === 0) {
        catalogListElem.innerHTML = '<li style="justify-content: center;">Каталог пуст или не найдено совпадений.</li>';
        return;
    }

    currentItems.forEach(item => { 
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="item-content">
                <img src="${item.imageUrl}" alt="${item.name}" class="item-image" 
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/60x60?text=Error';">
                
                <div class="item-details">
                    <strong>${item.name}</strong> 
                    (Категория: ${item.category}) — 
                    <span style="color: #28a745;">${item.price} KZT</span>
                </div>
            </div>
            <button class="remove-btn">Удалить</button>
        `;
        
        // Установка обработчика удаления
        li.querySelector('.remove-btn').addEventListener('click', () => {
            handleRemove(item.id); 
        });
        
        catalogListElem.appendChild(li); 
    });
};


// --- 2. Инициализация и обработчики событий ---

// Загрузка данных при старте
Catalog.loadInitialData(loadItems());
updateView(); 


// Обработчик кнопки "Добавить"
addBtn.addEventListener('click', () => {
    const name = nameInput.value;
    const price = priceInput.value;
    const category = categoryInput.value;
    const imageUrl = imageInput.value; // Чтение URL изображения

    if (Catalog.addItem(name, price, category, imageUrl)) { // Передача нового аргумента
        saveItems(Catalog.getAllItems()); 
        
        // Очистка формы, включая новое поле
        nameInput.value = '';
        priceInput.value = '';
        categoryInput.value = '';
        imageInput.value = '';
        
        updateView(); 
    } else {
        alert("Пожалуйста, заполните Название и укажите корректную положительную Цену.");
    }
});


// Обработчик кнопки "Найти" (Поиск/фильтрация)
searchBtn.addEventListener('click', () => {
    const keyword = searchInput.value;
    const results = Catalog.searchItems(keyword);
    updateView(results); // Рендерим отфильтрованный список
});


// Обработчик кнопки "Сброс"
resetBtn.addEventListener('click', () => {
    searchInput.value = '';
    updateView(); // Рендерим весь список
});